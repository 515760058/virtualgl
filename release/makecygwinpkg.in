#!/bin/sh

set -u
set -e
trap onexit INT
trap onexit TERM
trap onexit EXIT

TMPDIR=

onexit()
{
	if [ ! "$TMPDIR" = "" ]; then
		rm -rf $TMPDIR
	fi
}

APPNAME=@CMAKE_PROJECT_NAME@
VERSION=@VERSION@
PREFIX=@CMAKE_INSTALL_PREFIX@
SYSPREFIX=@VGL_SYSPREFIX@
SYSPKG=`test ! "$PREFIX" = "$SYSPREFIX" && echo 1 || echo 0`
DOCSYMLINK=`test ! "$PREFIX" = "/usr/share" -a @VGL_DOCSYMLINK@ = 1 && echo 1 || echo 0`

umask 022
TMPDIR=`mktemp -d /tmp/$APPNAME-build.XXXXXX`
__PWD=`pwd`

make install DESTDIR=$TMPDIR/pkg

mkdir -p $TMPDIR/pkg/usr/share/doc
mv $TMPDIR/pkg/$PREFIX/doc $TMPDIR/pkg/usr/share/doc/$APPNAME-$VERSION
if [ $DOCSYMLINK = 1 ]; then
	ln -fs /usr/share/doc/$APPNAME-$VERSION $TMPDIR/pkg/$PREFIX/doc
fi

if [ $SYSPKG = 1 ]; then
	mkdir -p $TMPDIR/pkg/$SYSPREFIX/bin
	for i in vglclient.exe vglconnect; do
		mv $TMPDIR/pkg/$PREFIX/bin/$i $TMPDIR/pkg/$SYSPREFIX/bin/
		ln -fs $SYSPREFIX/bin/$i $TMPDIR/pkg/$PREFIX/bin/
	done
fi

cd $TMPDIR/pkg
tar cfj ../$APPNAME-$VERSION-cygwin.tar.bz2 *
cd $__PWD
mv $TMPDIR/*.tar.bz2 .

exit 0
