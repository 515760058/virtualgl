#!/bin/sh

usage()
{
	echo "$0 <app name> <JPEG library type> <package path> <version> <build> <package architecture> <lib dir> <32-bit lib dir> <bin dir> <32-bit bin dir> <Open mediaLib lib dir> <32-bit Open mediaLib lib dir>"
	exit 1
}

ARCH=`uname -m`
if [ "$1" = "" ]; then usage $0; fi
APPNAME=$1
if [ "$2" = "" ]; then usage $0; fi
JPEGLIB=$2
if [ "$3" = "" ]; then usage $0; fi
PKGNAME=$3
if [ "$4" = "" ]; then usage $0; fi
VERSION=$4
if [ "$5" = "" ]; then usage $0; fi
BUILD=$5
if [ "$6" = "" ]; then usage $0; fi
DEBARCH=$6
if [ "$7" = "" ]; then usage $0; fi
LDIR=$7
if [ "$8" = "" ]; then usage $0; fi
LDIR32=$8
if [ "$9" = "" ]; then usage $0; fi
EDIR=$9
if [ "${10}" = "" ]; then usage $0; fi
EDIR32=${10}
if [ "$JPEGLIB" = "medialib" ]; then
	if [ "${11}" = "" ]; then usage $0; fi
	OMLDIR=${11}
	if [ "${12}" = "" ]; then usage $0; fi
	OMLDIR32=${12}
fi

rm -f $PKGNAME
umask 022
TMPDIR=`mktemp -d /tmp/vglbuild.XXXXXX`
mkdir $TMPDIR/DEBIAN || exit -1
(cat deb-control.tmpl | sed s/{__PKGNAME}/$APPNAME/g | sed s/{__VERSION}/$VERSION/g | sed s/{__BUILD}/$BUILD/g | sed s/{__ARCH}/$DEBARCH/g > $TMPDIR/DEBIAN/control) || exit -1

if [ "$JPEGLIB" = "ipp" ]; then
	echo "Depends: turbojpeg (>= 1.11)" >>$TMPDIR/DEBIAN/control
fi
mkdir -p $TMPDIR/usr/bin || exit -1
mkdir -p $TMPDIR/usr/lib || exit -1
if [ "$DEBARCH" = "amd64" ]; then
	mkdir -p $TMPDIR/usr/lib32 || exit -1
fi
mkdir -p $TMPDIR/opt/$APPNAME/bin || exit -1
mkdir -p $TMPDIR/opt/$APPNAME/fakelib || exit -1
if [ "$DEBARCH" = "amd64" ]; then
	mkdir -p $TMPDIR/opt/$APPNAME/fakelib/64 || exit -1
	ln -fs /opt/$APPNAME/fakelib/64 $TMPDIR/opt/$APPNAME/lib64 || exit -1
fi
install -m 755 $EDIR32/vglclient $TMPDIR/usr/bin/ || exit -1
install -m 755 $EDIR32/vglconfig $TMPDIR/usr/bin/ || exit -1
install -m 755 $EDIR32/vglconnect $TMPDIR/usr/bin/ || exit -1
install -m 755 $EDIR32/vgllogin $TMPDIR/usr/bin/ || exit -1
install -m 755 $EDIR32/vglrun $TMPDIR/usr/bin/ || exit -1
install -m 755 rr/vglgenkey $TMPDIR/usr/bin/ || exit -1
install -m 755 rr/vglserver_config $TMPDIR/usr/bin/ || exit -1
install -m 755 $EDIR32/tcbench $TMPDIR/opt/$APPNAME/bin/ || exit -1
install -m 755 $EDIR32/nettest $TMPDIR/opt/$APPNAME/bin/ || exit -1
install -m 755 $EDIR32/cpustat $TMPDIR/opt/$APPNAME/bin/ || exit -1
install -m 755 $EDIR32/glxinfo $TMPDIR/opt/$APPNAME/bin/ || exit -1
install -m 755 $EDIR32/glxspheres $TMPDIR/opt/$APPNAME/bin/ || exit -1
install -m 755 $LDIR/librrfaker.so $TMPDIR/usr/lib/ || exit -1
install -m 755 $LDIR/libdlfaker.so $TMPDIR/usr/lib/ || exit -1
install -m 755 $LDIR/libgefaker.so $TMPDIR/usr/lib/ || exit -1
if [ "$JPEGLIB" = "medialib" ]; then
	install -m 755 $OMLDIR/libopenmliblite.so $TMPDIR/usr/lib/ || exit -1
fi
if [ "$DEBARCH" = "amd64" ]; then
	install -m 755 $LDIR32/librrfaker.so $TMPDIR/usr/lib32/ || exit -1
	install -m 755 $LDIR32/libdlfaker.so $TMPDIR/usr/lib32/ || exit -1
	install -m 755 $LDIR32/libgefaker.so $TMPDIR/usr/lib32/ || exit -1
	install -m 755 $EDIR/glxspheres $TMPDIR/opt/$APPNAME/bin/glxspheres64 || exit -1
	install -m 755 $EDIR/vglconfig64 $TMPDIR/usr/bin/ || exit -1
	ln -fs /usr/lib/librrfaker.so $TMPDIR/opt/$APPNAME/fakelib/64/libGL.so || exit -1
	ln -fs /usr/bin/vglconfig64 $TMPDIR/opt/$APPNAME/bin/vglconfig64 || exit -1
	ln -fs /usr/lib32/librrfaker.so $TMPDIR/opt/$APPNAME/fakelib/libGL.so || exit -1
	if [ "$JPEGLIB" = "medialib" ]; then
		install -m 755 $OMLDIR32/libopenmliblite.so $TMPDIR/usr/lib32/ || exit -1
	fi
else
	ln -fs /usr/lib/librrfaker.so $TMPDIR/opt/$APPNAME/fakelib/libGL.so || exit -1
fi
ln -fs /usr/bin/vglclient $TMPDIR/opt/$APPNAME/bin/vglclient || exit -1
ln -fs /usr/bin/vglconfig $TMPDIR/opt/$APPNAME/bin/vglconfig || exit -1
ln -fs /usr/bin/vglconnect $TMPDIR/opt/$APPNAME/bin/vglconnect || exit -1
ln -fs /usr/bin/vglgenkey $TMPDIR/opt/$APPNAME/bin/vglgenkey || exit -1
ln -fs /usr/bin/vgllogin $TMPDIR/opt/$APPNAME/bin/vgllogin || exit -1
ln -fs /usr/bin/vglserver_config $TMPDIR/opt/$APPNAME/bin/vglserver_config || exit -1
ln -fs /usr/bin/vglrun $TMPDIR/opt/$APPNAME/bin/vglrun || exit -1
ln -fs /opt/$APPNAME/fakelib $TMPDIR/opt/$APPNAME/lib || exit -1
ln -fs /usr/share/doc/$APPNAME-$VERSION $TMPDIR/opt/$APPNAME/doc || exit -1
mkdir -p $TMPDIR/usr/share/doc/$APPNAME-$VERSION || exit -1
install -m 644 fltk/COPYING $TMPDIR/usr/share/doc/$APPNAME-$VERSION/LICENSE-FLTK.txt || exit -1
install -m 644 putty/LICENCE $TMPDIR/usr/share/doc/$APPNAME-$VERSION/LICENSE-PuTTY.txt || exit -1
install -m 644 x11windows/xauth.license $TMPDIR/usr/share/doc/$APPNAME-$VERSION/LICENSE-xauth.txt || exit -1
install -m 644 LGPL.txt $TMPDIR/usr/share/doc/$APPNAME-$VERSION/ || exit -1
install -m 644 LICENSE.txt $TMPDIR/usr/share/doc/$APPNAME-$VERSION/ || exit -1
install -m 644 ChangeLog.txt $TMPDIR/usr/share/doc/$APPNAME-$VERSION/ || exit -1
install -m 644 doc/index.html $TMPDIR/usr/share/doc/$APPNAME-$VERSION/ || exit -1
install -m 644 doc/*.png $TMPDIR/usr/share/doc/$APPNAME-$VERSION/ || exit -1
install -m 644 doc/*.gif $TMPDIR/usr/share/doc/$APPNAME-$VERSION/ || exit -1
install -m 644 doc/*.css $TMPDIR/usr/share/doc/$APPNAME-$VERSION/ || exit -1

sudo chown -R root:root $TMPDIR/* || exit -1
dpkg -b $TMPDIR $PKGNAME || exit -1
sudo rm -rf $TMPDIR
